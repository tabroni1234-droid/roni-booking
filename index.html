<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roni Fitness Factory | å°ˆå±¬é ç´„</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Roni V8.0 Intelligence Edition --- */
        :root {
            --bg-color: #080808;
            --card-bg: #101010;
            --primary-gold: #C8AA6E;
            --text-main: #E0E0E0;
            --text-muted: #888888;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Noto Serif TC', serif;
            margin: 0; padding: 20px;
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }

        .container {
            width: 100%; max-width: 420px;
            background: var(--card-bg);
            padding: 50px 40px;
            border: 1px solid rgba(200, 170, 110, 0.2);
            box-shadow: 0 40px 80px rgba(0,0,0,0.9);
            position: relative;
            overflow: hidden;
            background-image: url("https://www.transparenttextures.com/patterns/black-linen.png");
            min-height: 550px; 
        }

        /* è£é£¾è§’æ¨™ */
        .corner { position: absolute; width: 15px; height: 15px; border: 1px solid var(--primary-gold); }
        .tl { top: 10px; left: 10px; border-right: none; border-bottom: none; }
        .tr { top: 10px; right: 10px; border-left: none; border-bottom: none; }
        .bl { bottom: 10px; left: 10px; border-right: none; border-top: none; }
        .br { bottom: 10px; right: 10px; border-left: none; border-top: none; }

        header { text-align: center; margin-bottom: 40px; z-index: 2; position: relative; }
        
        .logo-box {
            width: 80px; height: 80px; margin: 0 auto 15px;
            display: flex; justify-content: center; align-items: center;
        }
        .logo-box img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
            border: 2px solid var(--primary-gold); padding: 3px;
        }

        h1 { font-family: 'Cinzel', serif; font-size: 20px; color: var(--primary-gold); margin: 0; letter-spacing: 2px; }
        .subtitle {
            font-family: 'Noto Serif TC', serif; font-size: 13px; color: var(--text-muted);
            border-top: 1px solid #333; border-bottom: 1px solid #333;
            display: inline-block; padding: 8px 15px; margin-top: 5px;
        }

        /* ç¿»é æ•ˆæœ */
        .step { display: none; animation: fadeIn 0.6s ease; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 30px; }
        label { display: block; font-size: 13px; color: var(--primary-gold); margin-bottom: 8px; letter-spacing: 1px; }

        input, select {
            width: 100%; padding: 10px 0;
            background: transparent; border: none;
            border-bottom: 1px solid #444;
            color: #fff; font-family: 'Noto Serif TC', serif; font-size: 16px;
            outline: none; border-radius: 0; appearance: none;
        }
        input:focus, select:focus { border-bottom-color: var(--primary-gold); }

        /* éš±è—å€å¡Š (ç”¨æ–¼å‚™è¨») */
        .hidden-block { display: none; margin-top: 10px; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* æŒ‰éˆ• */
        .btn-group { margin-top: 40px; display: flex; gap: 15px; }
        button {
            flex: 1; padding: 15px;
            background: transparent; border: 1px solid var(--primary-gold);
            color: var(--primary-gold); font-family: 'Cinzel', serif; font-weight: 700;
            cursor: pointer; transition: 0.3s;
        }
        button.primary { background: var(--primary-gold); color: #000; }
        button:active { transform: scale(0.98); }

        /* æç¤ºæ–‡å­— */
        .time-note {
            font-size: 12px; color: #666; margin-top: 15px; 
            border: 1px solid #333; padding: 10px; border-radius: 4px;
            line-height: 1.6;
        }

        /* ç¬¬ä¸‰é æ¨£å¼ */
        .success-icon { text-align: center; font-size: 50px; color: var(--primary-gold); margin-bottom: 20px; }
        .summary-box { background: rgba(255,255,255,0.05); padding: 20px; border: 1px solid #333; margin-bottom: 25px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; border-bottom: 1px dashed #333; padding-bottom: 5px; }
        .s-val { color: var(--primary-gold); text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>

    <header>
        <div class="logo-box">
            <img src="avatar.png" alt="Roni" onerror="this.style.display='none';">
        </div>
        <h1>Roni Fitness Factory</h1>
        <div class="subtitle">å¥èº«å·¥å» å˜‰ç¾©ã€æ°‘é›„çš†æœ‰æœå‹™</div>
    </header>

    <form id="bookingForm">
        <div class="step active" id="step1">
            <div class="form-group">
                <label>è²´è³“å§“å / NAME</label>
                <input type="text" name="name" id="inputName" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å…¨å">
            </div>
            <div class="form-group">
                <label>æ€§åˆ¥ / GENDER</label>
                <select name="gender" id="inputGender" required>
                    <option value="" disabled selected>è«‹é¸æ“‡</option>
                    <option value="ç”·">ç”· (Male)</option>
                    <option value="å¥³">å¥³ (Female)</option>
                </select>
            </div>
            <div class="form-group">
                <label>è¯çµ¡é›»è©± / PHONE</label>
                <input type="tel" name="phone" id="inputPhone" required placeholder="09xx-xxx-xxx" maxlength="10">
            </div>
            <div class="form-group">
                <label>è«®è©¢å» é¤¨ / LOCATION</label>
                <select name="factory" id="inputFactory" required>
                    <option value="" disabled selected>è«‹é¸æ“‡é ç´„å» é¤¨</option>
                    <option value="å¥èº«å·¥å» æ°‘é›„å» ">å¥èº«å·¥å»  - æ°‘é›„å» </option>
                    <option value="å¥èº«å·¥å» å˜‰ç¾©å» ">å¥èº«å·¥å»  - å˜‰ç¾©å» </option>
                </select>
            </div>
            <div class="btn-group">
                <button type="button" class="primary" onclick="goToStep(2)">NEXT STEP</button>
            </div>
        </div>

        <div class="step" id="step2">
            <div class="form-group">
                <label>é ç´„ç›®çš„ / PURPOSE</label>
                <select name="purpose" id="inputPurpose" required onchange="checkMemo(this.value)">
                    <option value="å…¥æœƒé«”é©—">å…¥æœƒé«”é©—</option>
                    <option value="èˆŠå®¢é ç´„">èˆŠå®¢é ç´„</option> <option value="è³‡æ–™è£œé½Š">è³‡æ–™è£œé½Š</option>
                    <option value="å…¶ä»–è«®è©¢">å…¶ä»–è«®è©¢</option>
                </select>
            </div>

            <div class="form-group hidden-block" id="memoGroup">
                <label>å‚™è¨» / MEMO (å¿…å¡«)</label>
                <input type="text" name="memo" id="inputMemo" placeholder="è«‹ç°¡è¿°æ‚¨çš„éœ€æ±‚...">
            </div>

            <div class="form-group">
                <label>é ç´„æ—¥æœŸ / DATE</label>
                <select name="dateSelect" id="dateSelect" required>
                    <option value="">è®€å–å¯é ç´„æ™‚æ®µ...</option>
                </select>
            </div>

            <div class="form-group">
                <label>é ç´„æ™‚æ®µ / TIME</label>
                <select name="timeSelect" id="timeSelect" required>
                    <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
                </select>
                <div class="time-note">
                    * åƒ…é¡¯ç¤º Roni ç•¶ç­æ™‚æ®µ<br>
                    * æ¬²é¸æ“‡å…¶ä»–æ™‚æ®µè«‹ç§è¨Š Roni å®˜æ–¹ Lineï¼Œç•¶å¤©å°‡äº¤ç”±åŒäº‹å”åŠ©ã€‚
                </div>
            </div>

            <div class="btn-group">
                <button type="button" onclick="goToStep(1)">BACK</button>
                <button type="submit" class="primary" id="submitBtn">CONFIRM</button>
            </div>
        </div>

        <div class="step" id="step3">
            <div class="success-icon"><i class="fa-regular fa-circle-check"></i></div>
            <div style="text-align:center; margin-bottom:20px; font-weight:bold;">æ­å–œæ‚¨é ç´„å®Œæˆï¼</div>
            <div class="summary-box" id="summaryContent"></div>
            
            <div class="btn-group" style="flex-direction:column;">
                <button type="button" class="primary" onclick="copyInfo()">è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
                <button type="button" onclick="addToCalendar()">åŠ å…¥ Google è¡Œäº‹æ›†</button>
            </div>
            <div style="text-align:center; font-size:12px; color:#666; margin-top:15px;">
                å»ºè­°æ‚¨å°‡è³‡è¨Šè²¼è‡³ TimeTree æˆ–è¨­å®šé¬§é˜æé†’
            </div>
        </div>
    </form>
</div>

<script>
    // ==========================================
    // âš™ï¸ ç³»çµ±è¨­å®š
    // ==========================================
    const CONFIG = {
        discordUrl: "https://discordapp.com/api/webhooks/1449799845144559731/pTkKrAfV2NlUayLtBqN2nNLAXj5ktq_6cXsYwEgrZCWjCFw7j8dFscCG7kVmyrhAlLps",
        googleScriptUrl: "https://script.google.com/macros/s/AKfycbyBNTeC51u7lKbzx_BOFqNwgTwkMoA0HFLN4aOxUPSUaRtErAmtrS-Ml5oM_F9oYCx-EQ/exec",
        lineUrl: "https://line.me/ti/p/@781uizhn",
        limitDate: "2025-12-28", // æœ€å¾Œå¯é ç´„æ—¥æœŸ
        limitTime: 18 // æœ€å¾Œä¸€å¤©åªåˆ° 18:00
    };

    // å­˜æ”¾å¾Œå°å›å‚³çš„ã€Œå·²é ç´„æ¸…å–®ã€
    let BOOKED_SLOTS = [];

    // --- åˆå§‹è¼‰å…¥ï¼šæŠ“å–å·²é ç´„æ™‚æ®µ ---
    window.onload = function() {
        fetchBookedSlots();
    };

    function fetchBookedSlots() {
        fetch(CONFIG.googleScriptUrl)
            .then(response => response.json())
            .then(data => {
                BOOKED_SLOTS = data; // å­˜å…¥å…¨åŸŸè®Šæ•¸
                initCalendar(); // è³‡æ–™å›ä¾†å¾Œå†ç”¢ç”Ÿæ—¥æœŸï¼Œç¢ºä¿åŒæ­¥
            })
            .catch(error => {
                console.error("ç„¡æ³•è®€å–å¾Œå°è³‡æ–™", error);
                initCalendar(); // å³ä½¿å¤±æ•—ä¹Ÿè¦è®“æ—¥æ›†é¡¯ç¤º
            });
    }

    // --- å‚™è¨»æ¬„é¡¯ç¤ºé‚è¼¯ ---
    function checkMemo(val) {
        const block = document.getElementById('memoGroup');
        const input = document.getElementById('inputMemo');
        if (val === 'å…¶ä»–è«®è©¢') {
            block.style.display = 'block';
            input.required = true;
        } else {
            block.style.display = 'none';
            input.required = false;
            input.value = ''; // æ¸…ç©º
        }
    }

    // --- ç¿»é  ---
    function goToStep(step) {
        if(step === 2) {
            // é©—è­‰ç¬¬ä¸€é 
            if(!document.getElementById('inputName').value || 
               !document.getElementById('inputPhone').value || 
               !document.getElementById('inputFactory').value) {
                alert("è«‹å®Œæ•´å¡«å¯«è³‡æ–™"); return;
            }
        }
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
    }

    // --- æ—¥æœŸèˆ‡æ™‚é–“ ---
    const dateSelect = document.getElementById('dateSelect');
    const timeSelect = document.getElementById('timeSelect');

    function initCalendar() {
        dateSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ—¥æœŸ</option>';
        const today = new Date();
        const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        
        for(let i=1; i<=30; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);
            
            const yyyy = d.getFullYear();
            const mm = (d.getMonth()+1).toString().padStart(2,'0');
            const dd = d.getDate().toString().padStart(2,'0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            
            if (dateStr > CONFIG.limitDate) break;

            const opt = document.createElement('option');
            opt.value = dateStr;
            opt.innerText = `${mm}/${dd} (${weekDays[d.getDay()]})`;
            dateSelect.appendChild(opt);
        }
    }

    // ç”¢ç”Ÿæ™‚é–“ (æ ¸å¿ƒé‚è¼¯ï¼šéæ¿¾å·²é ç´„)
    function initTime() {
        const dateVal = dateSelect.value;
        timeSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ™‚æ®µ</option>';
        if(!dateVal) return;

        let endH = (dateVal === CONFIG.limitDate) ? CONFIG.limitTime : 22; // 22:00 ä¸‹ç­

        for(let h=10; h<=endH; h++) { // 10:00 ä¸Šç­
            const timeStr = `${h.toString().padStart(2,'0')}:00`;
            const fullSlot = `${dateVal} ${timeStr}`; // æ ¼å¼ï¼š2025-12-16 10:00
            
            const opt = document.createElement('option');
            opt.value = timeStr;
            
            // ğŸš« æª¢æŸ¥æ˜¯å¦è¢«é ç´„
            // é€™è£¡ç”¨å¯¬é¬†æ¯”å°ï¼šåªè¦å¾Œå°å›å‚³çš„å­—ä¸²åŒ…å«é€™å€‹æ—¥æœŸæ™‚é–“ï¼Œå°±é–ä½
            const isBooked = BOOKED_SLOTS.some(slot => slot.includes(fullSlot));
            
            if (isBooked) {
                opt.disabled = true;
                opt.innerText = `${timeStr} (è©²æ™‚æ®µå·²è¢«é ç´„)`;
                opt.style.color = "#d9534f"; // ç´…è‰²æç¤º
            } else {
                opt.innerText = timeStr;
            }
            timeSelect.appendChild(opt);
        }
    }
    
    dateSelect.addEventListener('change', initTime);

    // --- é€å‡º ---
    const form = document.getElementById('bookingForm');
    form.addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const fullDateTime = `${data.dateSelect} ${data.timeSelect}`;
        
        // å¼·åˆ¶å¯«å…¥ Google Sheet çš„æ¬„ä½ä¿®æ­£
        formData.append("date", fullDateTime); // æ¬„ä½ F
        formData.set("phone", "'" + data.phone); // æ¬„ä½ D (åŠ å–®å¼•è™Ÿ)

        // Discord é€šçŸ¥
        const discordPayload = {
            username: "Roni é ç´„ç®¡å®¶",
            embeds: [{
                title: "ğŸ’ æ–°çš„é ç´„æˆç«‹",
                color: 13146734,
                fields: [
                    { name: "è²´è³“", value: `${data.name} (${data.gender})`, inline: true },
                    { name: "é›»è©±", value: data.phone, inline: true },
                    { name: "å» é¤¨", value: data.factory, inline: true },
                    { name: "æ™‚é–“", value: fullDateTime, inline: false },
                    { name: "é …ç›®", value: data.purpose, inline: true },
                    { name: "å‚™è¨»", value: data.memo || "ç„¡", inline: false }
                ]
            }]
        };

        Promise.all([
            fetch(CONFIG.discordUrl, { 
                method: "POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(discordPayload)
            }).catch(()=>{}),
            fetch(CONFIG.googleScriptUrl, { method: 'POST', body: formData }).catch(()=>{})
        ]).then(() => {
            renderSuccess(data, fullDateTime);
            goToStep(3);
        });
    });

    function renderSuccess(data, time) {
        const box = document.getElementById('summaryContent');
        box.innerHTML = `
            <div class="summary-item"><span>å§“å</span><span class="s-val">${data.name}</span></div>
            <div class="summary-item"><span>é›»è©±</span><span class="s-val">${data.phone}</span></div>
            <div class="summary-item"><span>å» é¤¨</span><span class="s-val">${data.factory}</span></div>
            <div class="summary-item"><span>æ™‚é–“</span><span class="s-val">${time}</span></div>
            <div class="summary-item"><span>é …ç›®</span><span class="s-val">${data.purpose}</span></div>
            <div class="summary-item"><span>å‚™è¨»</span><span class="s-val">${data.memo || '-'}</span></div>
        `;
    }

    function copyInfo() {
        const items = document.querySelectorAll('.summary-item');
        let text = "ã€Roni é ç´„ç¢ºèªã€‘\n";
        items.forEach(item => {
            text += `${item.children[0].innerText}ï¼š${item.children[1].innerText}\n`;
        });
        navigator.clipboard.writeText(text).then(() => alert("å·²è¤‡è£½ï¼"));
    }

    function addToCalendar() {
        // ç°¡æ˜“ Google Calendar Link
        const date = document.getElementById('dateSelect').value.replace(/-/g,'');
        const time = document.getElementById('timeSelect').value.replace(/:/g,'');
        const start = `${date}T${time}00`;
        const end = `${date}T${parseInt(time)+100}00`;
        const details = `é ç´„å» é¤¨ï¼š${document.getElementById('inputFactory').value}`;
        window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=Roniå¥é«”è«®è©¢&dates=${start}/${end}&details=${details}`, '_blank');
    }
</script>

</body>
</html>
